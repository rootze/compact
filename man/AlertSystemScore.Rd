% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/AlertSystemScore.R
\name{AlertSystemScore}
\alias{AlertSystemScore}
\title{AlertSystem: score pathway gene sets for a given module perturbation}
\usage{
AlertSystemScore(
  seurat_obj,
  gene_sets,
  perturbation_name,
  base_tag,
  baseline_assay = "RNA",
  group.by = NULL,
  out_dir = NULL,
  min_genes = 5,
  eps = 1e-10,
  summary_fun = c("mean", "median"),
  return_details = FALSE,
  verbose = TRUE,
  compute_concordance = TRUE,
  compute_robustness = TRUE,
  robust_effect_thresh = 0.01
)
}
\arguments{
\item{seurat_obj}{A Seurat object that already contains the perturbation
assay generated by \code{ModulePerturbation} (e.g. an assay named
\code{"M6_up"}).}

\item{gene_sets}{Named list of character vectors, each defining a pathway
gene set to score.}

\item{perturbation_name}{Name of the perturbation assay in \code{seurat_obj}
(e.g. \code{"M6_up"}).}

\item{base_tag}{Character string used to construct suffixes for baseline,
perturbation and logFC columns. For example, if \code{base_tag = "M6"}
and \code{baseline_assay = "RNA"}, generated columns will end in
\code{"_M6_RNA"}, \code{"_M6_M6up"}, and \code{"_M6_logFC"}.}

\item{baseline_assay}{Name of the baseline assay to use for pre-perturbation
UCell scoring (default \code{"RNA"}).}

\item{group.by}{Optional metadata column name used to group cells for
summarization. If \code{NULL}, all cells are treated as a single group
named \code{"all_cells"}.}

\item{out_dir}{Optional directory where AlertSystem outputs will be saved.
If provided, the function writes a single RDS file containing the full
\code{seurat_obj@misc$AlertSystem} list (AlertSystem_info) and a CSV
file with the pathway-level metrics table. If \code{NULL}, results are
not written to disk.}

\item{min_genes}{Minimum number of genes required to retain a gene set
after intersecting with the Seurat object's feature set.}

\item{eps}{Small numeric constant, epsilon, added to pre and post scores in the
logFC computation to avoid division by zero.}

\item{summary_fun}{Aggregation function used for group-wise effect
computation in the metrics table, one of \code{"mean"} or \code{"median"}.}

\item{return_details}{Logical; if \code{FALSE} (default), the function
returns only the updated Seurat object with results stored under
\code{seurat_obj@misc$AlertSystem}. If \code{TRUE}, a list is returned
containing the Seurat object, per-cell scores, metrics table, and any
file paths used for saving.}

\item{verbose}{Logical; if \code{TRUE} (default), progress messages are printed
during scoring and summarization. Set to \code{FALSE} to suppress console output.}

\item{compute_concordance}{Logical; if \code{TRUE} (default), compute a
concordance score per group × pathway as the fraction of cells whose logFC
sign matches the group-level effect sign.}

\item{compute_robustness}{Logical; if \code{TRUE} (default), a robustness metric is computed
per group × pathway as the fraction of all cells whose logFC is both
(i) above the magnitude threshold (|logFC| ≥ \code{robust_effect_thresh})
and (ii) has the same sign as the group-level effect.}

\item{robust_effect_thresh}{Numeric threshold on per-cell logFC used to define
"strong responders" in the robustness metric \code{robust_gt_thresh}.
For each group × pathway, \code{robust_gt_thresh} is the fraction of all
cells whose logFC is both (i) above this magnitude threshold
(|logFC| ≥ \code{robust_effect_thresh}) and (ii) has the same sign as the
group-level effect. If \code{robust_effect_thresh = 0}, this metric is
not computed and \code{robust_gt_thresh} is set to \code{NA}.}
}
\value{
If \code{return_details = FALSE} (default), returns the Seurat
object with \code{seurat_obj@misc$AlertSystem} populated and the
original metadata restored. If \code{return_details = TRUE}, returns a
list with elements:
\describe{
\item{seurat}{The updated Seurat object.}
\item{per_cell}{Data frame of per-cell UCell and logFC scores
(also stored in \code{seurat_obj@misc$AlertSystem$per_cell}).}
\item{metrics}{Long-format data frame of group-wise metrics
(effect, concordance, robustness) for each pathway
(also stored in \code{seurat_obj@misc$AlertSystem$metrics}).}
\item{info_file}{Path to the RDS file storing the full
\code{seurat_obj@misc$AlertSystem} list (or \code{NULL} if
\code{out_dir} was not provided).}
\item{metrics_file}{Path to the CSV file containing the metrics table
(or \code{NULL} if \code{out_dir} was not provided).}
}
}
\description{
This function implements the AlertSystem pathway scoring workflow for a
single module perturbation. It:
\enumerate{
\item Filters the input gene sets to features present in the Seurat object.
\item Computes UCell scores for each gene set on the baseline assay
(e.g. \code{"RNA"}) and on the perturbation assay
(e.g. \code{"M6_up"}).
\item Computes per-pathway log2 fold-changes,
\eqn{ \log_2 \left( \frac{\mathrm{post} + \varepsilon}{\mathrm{pre} + \varepsilon} \right) }.
\item Aggregates logFC per group (if \code{group.by} is provided) or
across all cells, and computes group-wise metrics including:
\itemize{
\item \emph{effect}: mean/median logFC,
\item \emph{concordance}: fraction of cells whose logFC sign matches
the group-level effect sign.
\item \emph{robustness} (optional): fraction of cells whose
logFC is both (i) above the magnitude threshold
(|logFC| ≥ \code{robust_effect_thresh}) and
(ii) has the same sign as the group-level effect.
}
\item Extracts all UCell (pre/post) and logFC columns created during
scoring and stores them, along with the metrics table and
run parameters, in \code{seurat_obj@misc$AlertSystem}.
\item Optionally saves all AlertSystem results as a single RDS file
(containing \code{seurat_obj@misc$AlertSystem}) and exports the
pathway-level metrics table as a CSV file in \code{out_dir}.
\item Restores the original \code{seurat_obj@meta.data}, so that the
object is not permanently bloated by intermediate score columns.
}
}
\examples{
\dontrun{
# Load pathway gene sets (local directory or GitHub fallback)
alertdatabasePATH <- "/dataPATH/"
genetype <- "mouse"  # or "human"

gene_sets_mouse <- LoadAlertSystemPathways(
  path = alertdatabasePATH,
  genetype= "mouse",
  database = "MSigDBhallmark"
)

# Basic usage: concordance on, robustness on (default)
seurat_obj <- AlertSystemScore(
  seurat_obj         = seurat_obj,
  gene_sets          = gene_sets_mouse,
  perturbation_name  = "M6_up",
  base_tag           = "M6",
  baseline_assay     = "RNA",
  group.by           = "cell_types_broad",
  out_dir            = tempdir(),   # save AlertSystem_info RDS + metrics CSV
  verbose            = TRUE
)

# Access metrics (effect + concordance + robustness)
head(seurat_obj@misc$AlertSystem$metrics)

# Example with a stricter robustness threshold
res <- AlertSystemScore(
  seurat_obj          = seurat_obj,
  gene_sets           = gene_sets_mouse,
  perturbation_name   = "M6_up",
  base_tag            = "M6",
  baseline_assay      = "RNA",
  group.by            = "cell_types_broad",
  compute_robustness = TRUE,
  robust_effect_thresh  = 0.1,   # only count cells with |logFC| ≥ 0.1
  return_details      = TRUE,
  verbose             = TRUE
)

head(res$metrics)
}
}
