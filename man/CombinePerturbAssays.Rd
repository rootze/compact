% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/CombinePerturbAssays.R
\name{CombinePerturbAssays}
\alias{CombinePerturbAssays}
\title{CombinePerturbAssays: create a composite perturb assay by delta superposition (sparse-safe; COUNTS-only)}
\usage{
CombinePerturbAssays(
  seurat_obj,
  perturb_assays,
  baseline_assay = "RNA",
  new_assay = paste(perturb_assays, collapse = "_"),
  require_provenance = FALSE,
  strict_provenance_check = TRUE,
  run_consistency_check_if_missing = TRUE,
  strict_consistency_check = FALSE,
  eps = 0.001,
  max_frac_changed = 0.35,
  max_abs_median = 0.05,
  max_abs_mean = 0.05,
  allow_unverified = TRUE,
  allow_dense = FALSE,
  normalize_method = "LogNormalize",
  scale.factor = 10000,
  verbose = TRUE
)
}
\arguments{
\item{seurat_obj}{A Seurat object containing baseline and perturbation assays.}

\item{perturb_assays}{Character vector of perturbation assay names to combine.}

\item{baseline_assay}{Character; baseline assay name (default \code{"RNA"}).}

\item{new_assay}{Character; name of the new composite assay.}

\item{require_provenance}{Logical; if TRUE, missing provenance triggers stop/warn.}

\item{strict_provenance_check}{Logical; if TRUE, stop on provenance mismatch; else warn.}

\item{run_consistency_check_if_missing}{Logical; if TRUE, run heuristic checks when provenance missing.}

\item{strict_consistency_check}{Logical; if TRUE, stop on suspicious heuristic results; else warn.}

\item{eps, max_frac_changed, max_abs_median, max_abs_mean}{Thresholds for heuristic checks.}

\item{allow_unverified}{Logical; if provenance missing and heuristic checks disabled, proceed only if TRUE.}

\item{allow_dense}{Logical; if FALSE (default), stop when any requested layer
returns a dense matrix (to avoid RAM blow-ups).}

\item{normalize_method}{Normalization method passed to \code{Seurat::NormalizeData()}
for creating the composite \code{data} layer (default \code{"LogNormalize"}).}

\item{scale.factor}{Scale factor passed to \code{Seurat::NormalizeData()} (default \code{1e4}).}
}
\value{
A Seurat object with a new composite perturbation assay.
}
\description{
This function combines multiple perturbation assays into a single composite
assay using additive superposition of perturbation deltas relative to a shared
baseline on the \code{counts} layer:
\deqn{P_{\mathrm{combined}} = B + \sum_i (P_i - B)}
}
\details{
Implementation note: this function avoids creating a large dense expanded
matrix. It combines perturbations strictly on the baseline feature space
(rows = \code{rownames(baseline)}). Features present in a perturb assay but
absent from baseline are dropped with a warning.

Baseline safety logic:
\itemize{
\item If all input assays have provenance (via \code{StampPerturbProvenance()}),
the function verifies recorded \code{baseline_assay} and
\code{baseline_layers} include \code{"counts"}.
\item If provenance is missing for any assay, the function emits a warning banner.
Optionally, it runs heuristic numeric checks on the \code{counts} layer
via \code{.CheckPerturbBaselineConsistency()} for the unstamped assays
(not a proof; may be less informative than checks on normalized data).
}

Data layer handling:
After combining \code{counts}, the function generates the composite assay's
\code{data} layer by running \code{Seurat::NormalizeData()} on the new assay
(e.g. \code{LogNormalize} with a configurable \code{scale.factor}).

Combine by delta-superposition (counts only):
\itemize{
\item \code{comp_counts = base_counts + \sum_i (pert_counts_i - base_counts)}
}

Requirements:
\itemize{
\item baseline assay must have layer \code{counts}
\item each perturb assay must have layer \code{counts}
\item all assays must share identical cell columns
}
}
\examples{
\dontrun{
# After creating perturb assays:
seurat_obj_perturb <- ModulePerturbation(
  seurat_obj_perturb,
  mod = "CBh-M6",
  perturb_dir = 5,
  perturbation_name = "M6_up",
  graph = "RNA_nn",
  n_hubs = 10
)

seurat_obj_perturb <- ModulePerturbation(
  seurat_obj_perturb,
  mod = "CBh-M2",
  perturb_dir = -2,
  perturbation_name = "M2_down",
  graph = "RNA_nn",
  n_hubs = 10
)

# Optional: stamp provenance (recommended)
seurat_obj_perturb <- StampPerturbProvenance(
  seurat_obj_perturb,
  perturb_assay = "M6_up",
  baseline_assay = "RNA"
)

seurat_obj_perturb <- StampPerturbProvenance(
  seurat_obj_perturb,
  perturb_assay = "M2_down",
  baseline_assay = "RNA"
)

seurat_obj_perturb <- CombinePerturbAssays(
  seurat_obj_perturb,
  perturb_assays = c("M6_up", "M2_down"),
  baseline_assay = "RNA",
  new_assay = "M6up_M2down",
  require_provenance = FALSE,
  run_consistency_check_if_missing = FALSE,
  allow_unverified = TRUE
)
}
}
